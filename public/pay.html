<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>おしゃべりあいこちゃん｜プレミアムお支払い</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 24px; line-height: 1.6; }
    .card { max-width: 560px; margin: 0 auto; padding: 20px; border: 1px solid #eee; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    button { padding: 12px 16px; border: 0; border-radius: 10px; background: #06c755; color: #fff; font-weight: 700; cursor: pointer; }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    .note { color: #666; font-size: .9rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>プレミアムに申し込む</h1>
    <p>LINEで本人確認後、決済ページへ移動します。</p>
    <p class="note">※ LINEアプリ内で開いてください。外部ブラウザだとID確認ができない場合があります。</p>
    <button id="go" disabled>決済ページへ進む</button>
    <div id="msg" class="note" style="margin-top:12px;"></div>
  </div>

  <script>
    const $go = document.getElementById("go");
    const $msg = document.getElementById("msg");

    async function main() {
      try {
        // 1) サーバーから LIFF ID を取得
        const conf = await fetch("/api/config").then(r => r.json());
        if (!conf.liffId) throw new Error("LIFF ID not configured");

        // 2) LIFF 初期化
        await liff.init({ liffId: conf.liffId });

        // LINE外ブラウザならログイン誘導
        if (!liff.isInClient() && !liff.isLoggedIn()) {
          $msg.textContent = "LINEログインへ移動します…";
          liff.login();
          return;
        }

        $go.disabled = false;

        $go.onclick = async () => {
          try {
            // 3) IDトークン取得
            const idToken = liff.getIDToken();
            if (!idToken) {
              alert("IDトークンを取得できませんでした。LINEアプリから開いてください。");
              return;
            }

            // 4) サーバーへ渡して Checkout URL を受け取る
            const res = await fetch("/create-checkout-session/liff", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ idToken })
            });
            if (!res.ok) throw new Error("failed to create checkout session");
            const { url } = await res.json();

            // 5) Stripe Checkout へ遷移
            location.href = url;
          } catch (e) {
            console.error(e);
            alert("エラーが発生しました。時間をおいてお試しください。");
          }
        };
      } catch (e) {
        console.error(e);
        $msg.textContent = "設定エラー：管理者にお問い合わせください。";
      }
    }

    main();
  </script>
</body>
</html>
