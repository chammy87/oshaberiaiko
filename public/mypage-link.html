<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆå¥‘ç´„çŠ¶æ³ï¼‰ï½œãŠã—ã‚ƒã¹ã‚Šã‚ã„ã“ã¡ã‚ƒã‚“</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#2f6df6; --border:#e8eaf0; --muted:#636a7a; --bg:#f5f7ff; --card:#fff;
      --ok:#2e7d32; --warn:#f57c00; --err:#d32f2f;
    }
    *{box-sizing:border-box}
    body{font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#222;margin:0;background:var(--bg)}
    header{padding:0;text-align:center;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    header img{
      width:min(90vw,300px); height:auto; display:block; margin:0 auto;
      border-bottom:2px solid #f0f2fa;
    }
    header h1{font-size:20px;font-weight:700;margin:10px 0 6px}
    main{max-width:760px;margin:0 auto;padding:20px 16px 40px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 18px;box-shadow:0 2px 8px rgba(0,0,0,.04);margin-bottom:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:12px;text-decoration:none;font-weight:700;cursor:pointer;border:1px solid var(--border);background:#fff;font-size:15px}
    .btn.brand{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .muted{color:var(--muted);font-size:13px}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .statuschip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:700}
    .status-ok{background:#e8f5e9;color:var(--ok)}
    .status-warn{background:#fff3e0;color:var(--warn)}
    .status-err{background:#ffebee;color:var(--err)}
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    th,td{text-align:left;padding:8px 4px;border-bottom:1px solid #f2f2f7;font-size:14px;vertical-align:top}
    th{color:#666;width:36%}
    td{color:#222}
    .break, .v code, td, .mono{word-break:break-all;overflow-wrap:anywhere}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    
   /* é£Ÿæãƒªã‚¹ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .ingredient-list{list-style:none;padding:0;margin:0}
    .ingredient-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border);gap:8px}
    .ingredient-item:last-child{border-bottom:none}
    .ingredient-info{flex:1}
    .ingredient-name{font-weight:600;color:#222}
    .ingredient-qty{color:var(--muted);font-size:13px;margin-left:8px}
    .ingredient-category{background:#e3f2fd;color:#1565c0;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600}
    .delete-btn{background:#ffebee;color:#d32f2f;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600}
    .delete-btn:hover{background:#ffcdd2}
    .add-form{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .add-form input,.add-form select{padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px}
    .add-form input[type="text"]{flex:1;min-width:120px}
    .add-form select{min-width:100px}
    .add-btn{background:var(--brand);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600}
    .add-btn:hover{opacity:0.9}
    .empty-message{color:var(--muted);text-align:center;padding:20px;font-size:14px}
    .refresh-btn{background:#e8f5e9;color:var(--ok);border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600}
    
    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .profile-section{margin-top:16px}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-weight:600;color:#222;margin-bottom:6px;font-size:14px}
    .form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit}
    .form-textarea{min-height:80px;resize:vertical}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--brand)}
    .save-profile-btn{background:var(--brand);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;width:100%}
    .save-profile-btn:hover{opacity:0.9}
    .save-profile-btn:disabled{opacity:0.5;cursor:not-allowed}
    .profile-hint{font-size:12px;color:var(--muted);margin-top:4px}
    
    @media (max-width:420px){
      th,td{font-size:13px}
      .btn{font-size:14px}
    }
  </style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <img src="./aiko-mypage.png" alt="ãŠã—ã‚ƒã¹ã‚Šã‚ã„ã“ã¡ã‚ƒã‚“ ãƒã‚¤ãƒšãƒ¼ã‚¸">
    <h1>å¥‘ç´„çŠ¶æ³ã‚’ç¢ºèª</h1>
  </header>

  <main>
    <div class="card">
      <p class="muted" id="authHint">ã€ŒLINEã§ç¶šã‘ã‚‹ã€ã‚’æŠ¼ã—ã¦æœ¬äººç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚</p>
      <div class="row">
        <button id="start" class="btn brand">LINEã§ç¶šã‘ã‚‹</button>
        <button id="reload" class="btn" style="display:none">å¥‘ç´„çŠ¶æ³ã‚’æ›´æ–°</button>
      </div>
    </div>

    <div class="card" id="statusCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0;font-size:18px">å¥‘ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
        <span id="statusChip" class="statuschip">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
      </div>
      <table>
        <tr>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
          <td>
            <span id="uid" class="mono break">-</span>
            <button id="copyUid" class="btn" style="padding:6px 10px;margin-left:6px;">ã‚³ãƒ”ãƒ¼</button>
          </td>
        </tr>
        <tr><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><td id="premium">-</td></tr>
        <tr><th>é–‹å§‹æ—¥æ™‚</th><td id="premiumSince" class="break">-</td></tr>
        <tr><th>æœ‰åŠ¹æœŸé™</th><td id="premiumUntil" class="break">-</td></tr>
        <tr><th>è§£ç´„äºˆç´„</th><td id="cancelPending">-</td></tr>
        <tr><th>è§£ç´„äºˆå®šæ—¥</th><td id="cancelAt" class="break">-</td></tr>
      </table>
      <div class="sep"></div>
      <div class="row">
        <button id="openPortal" class="btn brand" style="display:none">è«‹æ±‚ã«é–¢ã—ã¦ï¼ˆå¤‰æ›´ãƒ»è§£ç´„ï¼‰</button>
        <button id="upgradePremium" class="btn brand" style="display:none">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«ç™»éŒ²ã™ã‚‹</button>
        <button id="reload2" class="btn">å†å–å¾—</button>
      </div>
      <p class="muted" style="margin-top:8px" id="portalNote">â€» æ”¯æ‰•ã„æ–¹æ³•ã®å¤‰æ›´ã€è§£ç´„/å†é–‹ã€è«‹æ±‚å±¥æ­´ã®ç¢ºèªãŒã§ãã¾ã™ã€‚</p>
    </div>

    <!-- é£Ÿæãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="card" id="ingredientsCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0;font-size:18px">ğŸ¥¬ å†·è”µåº«ã®é£Ÿæ</h2>
        <button id="refreshIngredients" class="refresh-btn">æ›´æ–°</button>
      </div>
      
      <ul class="ingredient-list" id="ingredientList">
        <li class="empty-message">èª­ã¿è¾¼ã¿ä¸­...</li>
      </ul>
      
      <div class="sep"></div>
      
      <h3 style="margin:12px 0 8px;font-size:15px;color:var(--brand)">é£Ÿæã‚’è¿½åŠ </h3>
      <div class="add-form">
        <input type="text" id="newIngredientName" placeholder="é£Ÿæå" required>
        <input type="text" id="newIngredientQty" placeholder="æ•°é‡ï¼ˆä»»æ„ï¼‰">
        <select id="newIngredientCategory">
          <option value="é‡èœ">é‡èœ</option>
          <option value="è‚‰">è‚‰</option>
          <option value="é­š">é­š</option>
          <option value="ä¹³è£½å“">ä¹³è£½å“</option>
          <option value="æœç‰©">æœç‰©</option>
          <option value="èª¿å‘³æ–™">èª¿å‘³æ–™</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
        <button id="addIngredient" class="add-btn">è¿½åŠ </button>
      </div>
      
      <p class="muted" style="margin-top:10px">â€» LINEã§å†·è”µåº«ã®å†™çœŸã‚’é€ã‚‹ã¨è‡ªå‹•ã§é£Ÿæã‚’èªè­˜ã—ã¾ã™</p>
    </div>

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="card" id="profileCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0;font-size:18px">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
      </div>
      
      <p class="muted" style="margin-top:8px">ã‚ãªãŸã®æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ã‚ˆã‚Šãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸçŒ®ç«‹ã‚’ææ¡ˆã§ãã¾ã™ã€‚</p>
      
      <div class="profile-section">
        <div class="form-group">
          <label class="form-label">å®¶æ—æ§‹æˆ</label>
          <input type="text" id="householdSize" class="form-input" placeholder="ä¾‹: å¤§äºº2äººã€å­ä¾›1äººï¼ˆ3æ­³ï¼‰">
          <p class="profile-hint">äººæ•°ã¨å¹´é½¢ã‚’æ•™ãˆã¦ãã ã•ã„</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
          <input type="text" id="allergies" class="form-input" placeholder="ä¾‹: åµã€ä¹³è£½å“ã€ãã°">
          <p class="profile-hint">è©²å½“ã™ã‚‹ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">é£Ÿäº‹åˆ¶é™ãƒ»è‹¦æ‰‹ãªé£Ÿæ</label>
          <input type="text" id="dietaryRestrictions" class="form-input" placeholder="ä¾‹: ã‚»ãƒ­ãƒªã€ãƒ‘ã‚¯ãƒãƒ¼ã€è¾›ã„ã‚‚ã®">
          <p class="profile-hint">é¿ã‘ãŸã„é£Ÿæã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">å¥½ããªæ–™ç†ã‚¸ãƒ£ãƒ³ãƒ«</label>
          <input type="text" id="preferredCuisines" class="form-input" placeholder="ä¾‹: å’Œé£Ÿã€æ´‹é£Ÿã€ä¸­è¯ã€ã‚¤ã‚¿ãƒªã‚¢ãƒ³">
          <p class="profile-hint">ã‚ˆãä½œã‚‹ãƒ»é£Ÿã¹ãŸã„æ–™ç†ã®ã‚¸ãƒ£ãƒ³ãƒ«</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">æ–™ç†ã‚¹ã‚­ãƒ«</label>
          <select id="cookingSkill" class="form-select">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="åˆå¿ƒè€…">åˆå¿ƒè€…ï¼ˆç°¡å˜ãªãƒ¬ã‚·ãƒ”å¸Œæœ›ï¼‰</option>
            <option value="ä¸­ç´š">ä¸­ç´šï¼ˆæ™®é€šã®ãƒ¬ã‚·ãƒ”ã§OKï¼‰</option>
            <option value="ä¸Šç´š">ä¸Šç´šï¼ˆæœ¬æ ¼çš„ãªãƒ¬ã‚·ãƒ”ã‚‚æ­“è¿ï¼‰</option>
          </select>
        </div>
        
        <button id="saveProfile" class="save-profile-btn">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜</button>
      </div>
      
      <p class="muted" style="margin-top:12px">â€» è¨­å®šã—ãŸå†…å®¹ã¯çŒ®ç«‹ææ¡ˆã«åæ˜ ã•ã‚Œã¾ã™</p>
    </div>
  </main>

<script>
(function() {
  'use strict';

  const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const isAndroid = /Android/i.test(navigator.userAgent);
  const inLINE = /Line\//i.test(navigator.userAgent);

  const $ = (s)=>document.querySelector(s);
  const fmt = (iso)=>{
    if(!iso) return "-";
    try{
      const d = new Date(iso);
      return new Intl.DateTimeFormat('ja-JP',{timeZone:'Asia/Tokyo',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d).replace(/\//g,'-');
    }catch{ return iso; }
  };

  let currentUserId = null;
  let currentIdToken = null;
  let running = false;
  let liffInitialized = false;
  let ingredientsList = [];
  let profileData = null;

  const SESSION_KEY = 'mypage_start_count';
  const MAX_STARTS = 5;
  
  function checkStartCount() {
    const count = parseInt(sessionStorage.getItem(SESSION_KEY) || '0');
    if (count >= MAX_STARTS) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚\n\nå¯¾å‡¦æ³•:\n1. ã€Œå¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™\n2. LINEã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã™ã‚‹\n3. ã‚¹ãƒãƒ›ã‚’å†èµ·å‹•ã™ã‚‹');
      $("#start").disabled = true;
      $("#openExternal").style.display = "inline-flex";
      return false;
    }
    sessionStorage.setItem(SESSION_KEY, String(count + 1));
    return true;
  }

  $("#copyUid")?.addEventListener("click", async ()=>{
    const text = $("#uid")?.textContent?.trim();
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    } catch {
      const r = document.createRange();
      r.selectNodeContents($("#uid"));
      const s = window.getSelection();
      s.removeAllRanges(); s.addRange(r);
      alert("é¸æŠã•ã‚ŒãŸçŠ¶æ…‹ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„");
    }
  });

  async function getConfig(){
    const r = await fetch("/api/config", {cache:"no-store"});
    if(!r.ok) throw new Error("config load failed "+r.status);
    return r.json();
  }

  async function ensureLogin(liffId){
    if (!liffInitialized) {
      await liff.init({ liffId });
      await liff.ready;
      liffInitialized = true;
    }

    if (!liff.isLoggedIn()){
      console.log('ğŸ”„ æœªãƒ­ã‚°ã‚¤ãƒ³ - ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
      const redirectUri = location.origin + location.pathname;
      console.log('Redirect URI:', redirectUri);
      liff.login({ redirectUri: redirectUri });
      return null;
    }

    const decoded = liff.getDecodedIDToken();
    if (decoded && decoded.exp) {
      const nowSec = Math.floor(Date.now() / 1000);
      const expSec = decoded.exp;
      const timeDiff = expSec - nowSec;
      
      console.log('ğŸ• Token expiry check:', {
        exp: new Date(expSec * 1000).toISOString(),
        now: new Date(nowSec * 1000).toISOString(),
        diff: timeDiff + ' seconds'
      });
      
      if (timeDiff < 30) {
        console.log('âš ï¸ Token expired or expiring soon - re-login');
        const redirectUri = location.origin + location.pathname;
        try { liff.logout(); } catch(_){}
        liff.login({ redirectUri: redirectUri });
        return null;
      }
    }

    const idToken = liff.getIDToken();
    if (!idToken) {
      throw new Error('IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—ã€‚LIFFã®Scopeã« openid ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }

    console.log('âœ… IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ');
    return idToken;
  }

  async function resolveUser(idToken){
    const r = await fetch("/api/resolve-user", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ idToken }),
      cache: "no-store"
    });
    
    const data = await r.json().catch(()=> ({}));

    if (r.status === 401) {
      const details = (data?.details || '').toLowerCase();
      
      if (details.includes('audience') || details.includes('aud') || details.includes('channel id')) {
        throw new Error('âš ï¸ è¨­å®šã‚¨ãƒ©ãƒ¼ï¼šLIFFã®ãƒãƒ£ãƒãƒ«IDã¨ã‚µãƒ¼ãƒãƒ¼ã®LINE_LOGIN_CHANNEL_IDãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“');
      }
      
      throw new Error(data?.details || 'èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }

    if (!r.ok) {
      throw new Error((data?.error || "resolve-user failed") + (data?.details ? " - " + data.details : ""));
    }
    if (!data.userId) throw new Error("userId not returned");
    
    return data.userId;
  }

  // ===== é£Ÿæãƒªã‚¹ãƒˆæ©Ÿèƒ½ =====
  async function fetchIngredients(userId) {
    try {
      console.log('ğŸ¥¬ é£Ÿæãƒªã‚¹ãƒˆå–å¾—:', userId);
      
      const r = await fetch(`/api/chat/${encodeURIComponent(userId)}/ingredients`, {
        headers: { 
          'Authorization': `Bearer ${currentIdToken}`,
          'Content-Type': 'application/json'
        },
        cache: 'no-store'
      });
      
      if (!r.ok) {
        console.error('é£Ÿæãƒªã‚¹ãƒˆå–å¾—å¤±æ•—:', r.status);
        return;
      }
      
      const data = await r.json();
      ingredientsList = data.ingredients || [];
      
      renderIngredients();
      $("#ingredientsCard").style.display = "block";
      
    } catch (e) {
      console.error('é£Ÿæãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  function renderIngredients() {
    const list = $("#ingredientList");
    
    if (ingredientsList.length === 0) {
      list.innerHTML = '<li class="empty-message">é£ŸæãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>LINEã§å†·è”µåº«ã®å†™çœŸã‚’é€ã£ã¦ã¿ã¦ã­ï¼</li>';
      return;
    }
    
    list.innerHTML = ingredientsList.map((item, index) => `
      <li class="ingredient-item">
        <div class="ingredient-info">
          <span class="ingredient-name">${escapeHtml(item.name)}</span>
          ${item.quantity ? `<span class="ingredient-qty">${escapeHtml(item.quantity)}</span>` : ''}
        </div>
        <span class="ingredient-category">${escapeHtml(item.category || 'ãã®ä»–')}</span>
        <button class="delete-btn" onclick="window.deleteIngredient(${index})">å‰Šé™¤</button>
      </li>
    `).join('');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  window.deleteIngredient = async function(index) {
    if (!confirm(`ã€Œ${ingredientsList[index].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    
    ingredientsList.splice(index, 1);
    renderIngredients();
    await saveIngredients();
  };

  async function addIngredientHandler() {
    const name = $("#newIngredientName").value.trim();
    const qty = $("#newIngredientQty").value.trim();
    const category = $("#newIngredientCategory").value;
    
    if (!name) {
      alert('é£Ÿæåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    ingredientsList.push({
      name: name,
      quantity: qty,
      category: category
    });
    
    renderIngredients();
    await saveIngredients();
    
    $("#newIngredientName").value = '';
    $("#newIngredientQty").value = '';
  }

  async function saveIngredients() {
    if (!currentUserId || !currentIdToken) return;
    
    try {
      console.log('ğŸ’¾ é£Ÿæãƒªã‚¹ãƒˆä¿å­˜:', ingredientsList.length, 'ä»¶');
      
      const r = await fetch(`/api/chat/${encodeURIComponent(currentUserId)}/ingredients`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${currentIdToken}`
        },
        body: JSON.stringify({
          ingredients: ingredientsList,
          notes: ''
        })
      });
      
      if (!r.ok) {
        throw new Error('ä¿å­˜å¤±æ•—: ' + r.status);
      }
      
      console.log('âœ… é£Ÿæãƒªã‚¹ãƒˆä¿å­˜å®Œäº†');
      
    } catch (e) {
      console.error('é£Ÿæãƒªã‚¹ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  }

  // ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½ =====
  async function fetchProfile(userId) {
    try {
      console.log('ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—:', userId);
      
      const r = await fetch(`/api/chat/${encodeURIComponent(userId)}/profile`, {
        headers: { 
          'Authorization': `Bearer ${currentIdToken}`,
          'Content-Type': 'application/json'
        },
        cache: 'no-store'
      });
      
      if (!r.ok) {
        console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å¤±æ•—:', r.status);
        return;
      }
      
      const data = await r.json();
      profileData = data.profile || {};
      
      renderProfile();
      $("#profileCard").style.display = "block";
      
    } catch (e) {
      console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  function renderProfile() {
    if (!profileData) return;
    
    $("#householdSize").value = profileData.householdSize || '';
    $("#allergies").value = profileData.allergies || '';
    $("#dietaryRestrictions").value = profileData.dietaryRestrictions || '';
    $("#preferredCuisines").value = profileData.preferredCuisines || '';
    $("#cookingSkill").value = profileData.cookingSkill || '';
  }

  async function saveProfile() {
    if (!currentUserId || !currentIdToken) return;
    
    const saveBtn = $("#saveProfile");
    saveBtn.disabled = true;
    saveBtn.textContent = 'ä¿å­˜ä¸­...';
    
    try {
      console.log('ğŸ’¾ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜:', currentUserId);
      
      const profile = {
        householdSize: $("#householdSize").value.trim(),
        allergies: $("#allergies").value.trim(),
        dietaryRestrictions: $("#dietaryRestrictions").value.trim(),
        preferredCuisines: $("#preferredCuisines").value.trim(),
        cookingSkill: $("#cookingSkill").value
      };
      
      const r = await fetch(`/api/chat/${encodeURIComponent(currentUserId)}/profile`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${currentIdToken}`
        },
        body: JSON.stringify(profile)
      });
      
      if (!r.ok) {
        throw new Error('ä¿å­˜å¤±æ•—: ' + r.status);
      }
      
      console.log('âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜å®Œäº†');
      alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\næ¬¡å›ã®çŒ®ç«‹ææ¡ˆã«åæ˜ ã•ã‚Œã¾ã™ã€‚');
      
      profileData = profile;
      
    } catch (e) {
      console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜';
    }
  }

  async function fetchStatus(userId){
    const r = await fetch(`/api/user/${encodeURIComponent(userId)}`, { cache:"no-store" });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error("status failed " + r.status);

    $("#uid").textContent = userId;
    $("#premium").textContent = data.premium ? "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼ˆæœ‰åŠ¹ï¼‰" : "ç„¡æ–™ãƒ—ãƒ©ãƒ³";
    $("#premiumSince").textContent = fmt(data.premiumSince);
    $("#premiumUntil").textContent = fmt(data.premiumUntil);
    $("#cancelPending").textContent = data.cancelPending ? "ã‚ã‚Š" : "ãªã—";
    $("#cancelAt").textContent = fmt(data.cancelAt);

    const chip = $("#statusChip");
    chip.className = "statuschip " + (data.premium ? (data.cancelPending ? "status-warn":"status-ok") : "status-err");
    chip.textContent = data.premium ? (data.cancelPending ? "æœ‰åŠ¹ï¼ˆè§£ç´„äºˆç´„ã‚ã‚Šï¼‰" : "æœ‰åŠ¹") : "æœªå¥‘ç´„ / æœŸé™åˆ‡ã‚Œ";

    if (data.premium) {
      $("#openPortal").style.display = "inline-flex";
      $("#upgradePremium").style.display = "none";
    } else {
      $("#openPortal").style.display = "none";
      $("#upgradePremium").style.display = "inline-flex";
    }

    $("#statusCard").style.display = "block";
    $("#authHint").textContent = "æœ¬äººç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
    $("#reload").style.display = "inline-flex";
    $("#start").style.display = "none";
    
    // é£Ÿæãƒªã‚¹ãƒˆã‚‚å–å¾—
    await fetchIngredients(userId);
    
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚‚å–å¾—
    await fetchProfile(userId);
    
    sessionStorage.removeItem(SESSION_KEY);
  }

  async function openPortal(){
    if(!currentUserId) {
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    console.log('ğŸ”„ Opening billing portal for user:', currentUserId);
    
    try {
      const portalUrl = `/billing-portal?userId=${encodeURIComponent(currentUserId)}`;
      console.log('Portal URL:', portalUrl);
      window.location.href = portalUrl;
    } catch (e) {
      console.error('Portal open error:', e);
      alert('è«‹æ±‚ãƒšãƒ¼ã‚¸ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  }

  async function upgradeToPremium(){
    if(!currentUserId) {
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    console.log('ğŸ”„ Redirecting to premium registration for user:', currentUserId);
    window.location.href = 'https://www.oshaberiaiko.com/pay.html';
  }

  async function startFlow(){
    if(running) return;
    running = true;
    
    if (!checkStartCount()) {
      running = false;
      return;
    }
    
    $("#statusCard").style.display = "none";
    $("#ingredientsCard").style.display = "none";
    $("#profileCard").style.display = "none";
    $("#reload").style.display = "none";
    $("#start").disabled = true;
    $("#start").textContent = "èª­ã¿è¾¼ã¿ä¸­...";

    try{
      const { liffIdMypage, liffId } = await getConfig();
      const useId = liffIdMypage || liffId;
      
      if(!useId) {
        throw new Error("LIFF_ID_MYPAGE ãŒæœªè¨­å®šã§ã™ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
      }

      const idToken = await ensureLogin(useId);
      if(!idToken) {
        console.log('ğŸ”„ Redirecting to LINE login...');
        return;
      }

      currentIdToken = idToken;

      const userId = await resolveUser(idToken);
      if(!userId) {
        console.log('ğŸ”„ Redirecting after user resolution...');
        return;
      }
      
      currentUserId = userId;
      console.log('âœ… User ID resolved:', userId);

      const timeout = new Promise((_,rej)=> 
        setTimeout(()=>rej(new Error('render_timeout')), 10000)
      );
      
      await Promise.race([ fetchStatus(userId), timeout ]);

      $("#start").style.display = "none";
      $("#reload").style.display = "inline-flex";
      
    } catch(e) {
      console.error('âŒ startFlow error:', e);
      
      if (e.message === 'render_timeout' && isAndroid && inLINE) {
        console.log('âš ï¸ Androidæç”»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
        if (window.liff && liff.openWindow) {
          liff.openWindow({ url: location.href.split('#')[0].split('?')[0], external: true });
          return;
        }
      }
      
      const errorMsg = e.message || String(e);
      console.error('Error details:', errorMsg);
      
      let userMsg = "ãƒã‚¤ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n";
      
      if (errorMsg.includes('exp') || errorMsg.includes('æœŸé™')) {
        userMsg += "èªè¨¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚\nã‚‚ã†ä¸€åº¦ã€ŒLINEã§ç¶šã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
      } else if (errorMsg.includes('Channel ID') || errorMsg.includes('aud')) {
        userMsg += "è¨­å®šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚\nç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚";
      } else {
        userMsg += errorMsg + "\n\nã€Œå¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€ãƒœã‚¿ãƒ³ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚";
      }
      
      alert(userMsg);
      
      $("#start").textContent = "LINEã§ç¶šã‘ã‚‹";
      $("#start").disabled = false;
      
    } finally {
      if ($("#start").textContent === "èª­ã¿è¾¼ã¿ä¸­...") {
        $("#start").textContent = "LINEã§ç¶šã‘ã‚‹";
      }
      $("#start").disabled = false;
      running = false;
    }
  }

  $("#start")?.addEventListener("click", startFlow);
  $("#reload")?.addEventListener("click", async ()=>{
    if(!currentUserId) return startFlow();
    await fetchStatus(currentUserId);
  });
  $("#reload2")?.addEventListener("click", async ()=>{
    if(currentUserId) await fetchStatus(currentUserId);
  });
  $("#openPortal")?.addEventListener("click", openPortal);
  $("#upgradePremium")?.addEventListener("click", upgradeToPremium);
  
  // é£Ÿæãƒªã‚¹ãƒˆç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  $("#addIngredient")?.addEventListener("click", addIngredientHandler);
  $("#refreshIngredients")?.addEventListener("click", () => {
    if (currentUserId) fetchIngredients(currentUserId);
  });
  $("#newIngredientName")?.addEventListener("keypress", (e) => {
    if (e.key === 'Enter') addIngredientHandler();
  });
  
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  $("#saveProfile")?.addEventListener("click", saveProfile);

  window.addEventListener("DOMContentLoaded", ()=>{
    const params = new URLSearchParams(location.search);
    if (params.has('retry')) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ããƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
      $("#start").disabled = true;
      return;
    }
    
    startFlow();
  });
})();
</script>
</body>
</html>
