<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆå¥‘ç´„çŠ¶æ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ï½œãŠã—ã‚ƒã¹ã‚Šã‚ã„ã“ã¡ã‚ƒã‚“</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#2f6df6; --border:#e8eaf0; --muted:#636a7a; --bg:#fff; --card:#fff; --chip:#f1f5ff;
      --ok:#2e7d32; --warn:#f57c00; --err:#d32f2f;
    }
    *{box-sizing:border-box}
    body{font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#222;margin:0;background:var(--bg)}
    header{padding:20px;text-align:center;background:#f8f9ff;border-bottom:1px solid var(--border)}
    header h1{font-size:22px;margin:0;font-weight:700}
    header p{color:#555;margin:6px 0 0;font-size:14px}
    .wrap{max-width:760px;margin:24px auto;padding:0 16px}
    .card{border:1px solid var(--border);border-radius:14px;padding:16px;background:var(--card);margin-bottom:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:12px 16px;border-radius:12px;text-decoration:none;font-weight:700;cursor:pointer;border:1px solid var(--border);background:#fff}
    .btn.brand{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.ghost{background:#fff;color:#222}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .muted{color:var(--muted)}
    .kvs{display:grid;grid-template-columns:140px 1fr;gap:8px 12px;margin-top:8px}
    .k{color:#555}
    .v code{background:#f5f5f5;border-radius:6px;padding:2px 6px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);font-weight:700}
    .chip.ok{background:#e8f5e9;color:var(--ok)}
    .chip.warn{background:#fff3e0;color:var(--warn)}
    .chip.err{background:#ffebee;color:var(--err)}
    #log{font:12px ui-monospace,Menlo,Consolas,monospace;color:#555;white-space:pre-wrap;background:#f5f5f5;padding:8px;border-radius:6px;max-height:280px;overflow-y:auto}
    .error{color:var(--err);font-weight:700}
    .sep{height:1px;background:var(--border);margin:12px 0}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
    <p class="muted">ç¾åœ¨ã®å¥‘ç´„çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã€è«‹æ±‚ç®¡ç†ç”»é¢ï¼ˆStripeï¼‰ã¸é€²ã‚ã¾ã™ã€‚</p>
  </header>

  <div class="wrap">
    <div class="card" id="authCard">
      <p class="muted" id="authHint">ã€ŒLINEã§ç¶šã‘ã‚‹ã€ã‚’æŠ¼ã—ã¦æœ¬äººç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚</p>
      <div class="row">
        <button id="start" class="btn brand">LINEã§ç¶šã‘ã‚‹</button>
        <button id="reload" class="btn ghost" style="display:none">å¥‘ç´„çŠ¶æ³ã‚’æ›´æ–°</button>
      </div>
      <div id="log" style="margin-top:8px"></div>
    </div>

    <div class="card" id="statusCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0;font-size:18px">å¥‘ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
        <span id="statusChip" class="chip">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
      </div>
      <div class="kvs">
        <div class="k">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</div><div class="v"><code id="uid">-</code></div>
        <div class="k">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div><div class="v" id="premium">-</div>
        <div class="k">é–‹å§‹æ—¥æ™‚</div><div class="v" id="premiumSince">-</div>
        <div class="k">æœ‰åŠ¹æœŸé™</div><div class="v" id="premiumUntil">-</div>
        <div class="k">è§£ç´„äºˆç´„</div><div class="v" id="cancelPending">-</div>
        <div class="k">è§£ç´„äºˆå®šæ—¥</div><div class="v" id="cancelAt">-</div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button id="openPortal" class="btn brand">è«‹æ±‚ãƒãƒ¼ã‚¿ãƒ«ã‚’é–‹ã</button>
        <button id="reload2" class="btn ghost">å†å–å¾—</button>
      </div>
      <p class="muted" style="margin-top:8px">â€» ãƒãƒ¼ã‚¿ãƒ«ã§ã¯æ”¯æ‰•ã„æ–¹æ³•ã®å¤‰æ›´ã€è§£ç´„/å†é–‹ã€è«‹æ±‚å±¥æ­´ã®ç¢ºèªãŒã§ãã¾ã™ã€‚</p>
    </div>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const inLINE = /Line\//i.test(navigator.userAgent || "");
  let currentUserId = null;
  let running = false;

  const log = (m, isError=false)=>{
    const el=$("#log");
    const time = new Date().toLocaleTimeString('ja-JP');
    const prefix = isError ? 'âŒ' : 'ğŸ”';
    const className = isError ? 'error' : '';
    el.innerHTML += `<div class="${className}">[${time}] ${prefix} ${m}</div>`;
    el.scrollTop = el.scrollHeight;
  };

  const fmt = (iso)=>{
    if(!iso) return "-";
    try{
      const d = new Date(iso); // ISO from API (UTC)
      // è¡¨ç¤ºã¯æ—¥æœ¬æ™‚é–“
      return new Intl.DateTimeFormat('ja-JP', {
        timeZone: 'Asia/Tokyo',
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      }).format(d).replace(/\//g, '-');
    }catch{ return iso; }
  };

  async function getConfig(){
    const r = await fetch("/api/config",{cache:"no-store"});
    if(!r.ok) throw new Error("config load failed "+r.status);
    return r.json();
  }

  async function ensureLogin(liffId){
    log("LIFF init: " + liffId);
    await liff.init({ liffId });
    await liff.ready;
    log("LIFFåˆæœŸåŒ–å®Œäº†");
    if(!liff.isLoggedIn()){
      log("æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ LINEãƒ­ã‚°ã‚¤ãƒ³ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ");
      liff.login({ redirectUri: location.href });
      return null;
    }
    const idToken = liff.getIDToken();
    if(!idToken) throw new Error("IDãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆScopeã« openid ãŒå¿…è¦ï¼‰");
    log("âœ… IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ (é•·ã•: "+idToken.length+"æ–‡å­—)");
    return idToken;
  }

  async function resolveUser(idToken){
    log("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè§£æ±ºä¸­â€¦");
    const r = await fetch("/api/resolve-user",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ idToken })
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok){
      const errorMsg = data?.error || "resolve-user failed";
      const details = data?.details || "";
      const hint = data?.hint || "";
      throw new Error(`${errorMsg}${details ? ' - '+details : ''}${hint ? ' ('+hint+')' : ''}`);
    }
    if(!data.userId) throw new Error("userId not returned");
    log("âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: "+data.userId);
    return data.userId;
  }

  async function fetchStatus(userId){
    log("å¥‘ç´„çŠ¶æ³ã‚’å–å¾—ä¸­â€¦");
    const r = await fetch(`/api/user/${encodeURIComponent(userId)}`, { cache:"no-store" });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error("status failed " + r.status);

    // åæ˜ 
    $("#uid").textContent = userId;
    $("#premium").textContent = data.premium ? "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼ˆæœ‰åŠ¹ï¼‰" : "ç„¡æ–™ãƒ—ãƒ©ãƒ³";
    $("#premiumSince").textContent = fmt(data.premiumSince);
    $("#premiumUntil").textContent = fmt(data.premiumUntil);
    $("#cancelPending").textContent = data.cancelPending ? "ã‚ã‚Š" : "ãªã—";
    $("#cancelAt").textContent = fmt(data.cancelAt);

    const chip = $("#statusChip");
    chip.className = "chip " + (data.premium
      ? (data.cancelPending ? "warn" : "ok")
      : "err");
    chip.textContent = data.premium
      ? (data.cancelPending ? "æœ‰åŠ¹ï¼ˆè§£ç´„äºˆç´„ã‚ã‚Šï¼‰" : "æœ‰åŠ¹")
      : "æœªå¥‘ç´„/æœŸé™åˆ‡ã‚Œ";

    $("#statusCard").style.display = "block";
    $("#authHint").textContent = "æœ¬äººç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚å¥‘ç´„çŠ¶æ³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚";
  }

  async function openPortal(){
    if(!currentUserId) return;
    const url = `/billing-portal?userId=${encodeURIComponent(currentUserId)}`;
    log("Stripeè«‹æ±‚ãƒãƒ¼ã‚¿ãƒ«ã¸ç§»å‹•: " + url);
    location.href = url;
  }

  async function startFlow(){
    if(running) return;
    running = true;
    $("#log").innerHTML = "";
    $("#statusCard").style.display = "none";
    $("#reload").style.display = "none";
    $("#start").disabled = true;

    try{
      log("è¨­å®šèª­ã¿è¾¼ã¿ä¸­â€¦");
      const { liffIdMypage, liffId } = await getConfig();
      const useId = liffIdMypage || liffId;
      if(!useId) throw new Error("LIFF_ID_MYPAGE ãŒæœªè¨­å®šã§ã™ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");

      log("ä½¿ç”¨ã™ã‚‹LIFF ID: " + useId);
      const idToken = await ensureLogin(useId);
      if(!idToken){
        log("â†ª LINEãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸é·ç§»ã—ã¾ã™");
        return;
      }

      currentUserId = await resolveUser(idToken);
      await fetchStatus(currentUserId);
      $("#reload").style.display = "inline-flex";
    }catch(e){
      console.error(e);
      log("ã‚¨ãƒ©ãƒ¼: " + (e?.message || e), true);
      alert(
        "ãƒã‚¤ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + (e.message || e) +
        "\n\nï¼ˆãƒ’ãƒ³ãƒˆï¼‰LIFFã®Scopeã« `openid` ã‚’å«ã‚ã€" +
        "LINEãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ£ãƒãƒ«IDã¨ã‚µãƒ¼ãƒã® `LINE_LOGIN_CHANNEL_ID` ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
      );
    }finally{
      $("#start").disabled = false;
      running = false;
    }
  }

  // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
  $("#start").addEventListener("click", startFlow);
  $("#reload").addEventListener("click", async ()=>{
    if(!currentUserId) return startFlow();
    await fetchStatus(currentUserId);
  });
  $("#reload2").addEventListener("click", async ()=>{
    if(currentUserId) await fetchStatus(currentUserId);
  });
  $("#openPortal").addEventListener("click", openPortal);

  // å¿…è¦ãªã‚‰è‡ªå‹•é–‹å§‹
  // window.addEventListener("DOMContentLoaded", startFlow);
</script>
</body>
</html>
