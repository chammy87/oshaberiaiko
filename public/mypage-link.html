<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>マイページ（契約状況）｜おしゃべりあいこちゃん</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#2f6df6; --border:#e8eaf0; --muted:#636a7a; --ok:#2e7d32; --warn:#f57c00; --err:#d32f2f;
      --bg:#f6f7ff; --card:#fff;
    }
    *{box-sizing:border-box}
    body{font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#222;margin:0}
    header{background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);padding:10px 0 14px;text-align:center}
    header img{width:68%;max-width:320px;display:block;margin:0 auto 6px auto} /* ← 小さめ */
    header h1{font-size:18px;margin:0;font-weight:700;color:#222}
    main{max-width:760px;margin:16px auto 32px;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 16px 18px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:11px 16px;border-radius:12px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:#fff}
    .btn.brand{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.ghost{background:#fff;color:#222}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .muted{color:var(--muted);font-size:13px}
    .kvs{display:grid;grid-template-columns:140px 1fr;gap:8px 12px;margin-top:8px}
    .k{color:#555}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:700}
    .ok{background:#e8f5e9;color:var(--ok)}
    .warn{background:#fff3e0;color:var(--warn)}
    .err{background:#ffebee;color:var(--err)}
    #log{display:none;font:12px ui-monospace,Menlo,Consolas,monospace;color:#555;white-space:pre-wrap;background:#f5f5f5;padding:8px;border-radius:8px;max-height:260px;overflow-y:auto}
    .error{color:var(--err);font-weight:700}
    .sep{height:1px;background:var(--border);margin:12px 0}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <!-- 画像は public/aiko-mypage.png を使用 -->
    <img src="/aiko-mypage.png" alt="おしゃべりあいこちゃん マイページ">
    <h1>契約状況を確認</h1>
  </header>

  <main>
    <div class="card">
      <p class="muted" id="hint">「LINEで続ける」を押して本人確認を行います。</p>
      <div class="row" style="margin:6px 0 10px">
        <button id="start" class="btn brand">LINEで続ける</button>
        <button id="reload" class="btn ghost" style="display:none">契約状況を更新</button>
        <button id="toggleLog" class="btn ghost" style="margin-left:auto">詳細ログを開く</button>
      </div>
      <div id="log"></div>
    </div>

    <div class="card" id="statusCard" style="display:none;margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0;font-size:18px">契約ステータス</h2>
        <span id="statusChip" class="chip">読み込み中…</span>
      </div>
      <div class="kvs">
        <div class="k">ユーザーID</div><div id="uid">-</div>
        <div class="k">ステータス</div><div id="premium">-</div>
        <div class="k">開始日時</div><div id="premiumSince">-</div>
        <div class="k">有効期限</div><div id="premiumUntil">-</div>
        <div class="k">解約予約</div><div id="cancelPending">-</div>
        <div class="k">解約予定日</div><div id="cancelAt">-</div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button id="openPortal" class="btn brand">請求ポータルを開く</button>
        <button id="reload2" class="btn ghost">再取得</button>
      </div>
      <p class="muted" style="margin-top:8px">※ ポータルでは支払い方法の変更、解約/再開、請求履歴の確認ができます。</p>
    </div>
  </main>

<script>
  const $ = s => document.querySelector(s);
  const log = (m, err=false)=>{
    const el=$("#log");
    const time = new Date().toLocaleTimeString('ja-JP');
    el.style.display = el.style.display || "none";
    el.innerHTML += `[${time}] ${err?'❌':'🔍'} ${m}\n`;
    el.scrollTop = el.scrollHeight;
  };
  $("#toggleLog").addEventListener("click", () => {
    const el=$("#log"); el.style.display = (el.style.display==="none"||!el.style.display) ? "block":"none";
  });

  // JST表示整形
  const fmt = iso => {
    if(!iso) return "-";
    try{
      const d = new Date(iso);
      return new Intl.DateTimeFormat('ja-JP',{timeZone:'Asia/Tokyo',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d).replace(/\//g,'-');
    }catch(_){ return iso; }
  };

  let running = false;
  let currentUserId = null;

  async function getConfig(){
    const r = await fetch("/api/config",{cache:"no-store"});
    if(!r.ok) throw new Error("config load failed " + r.status);
    return r.json();
  }

  async function ensureLogin(liffId){
    log("LIFF init: " + liffId);
    await liff.init({ liffId });
    await liff.ready;              // ← 初期化完了を待つ
    log("LIFF初期化完了");

    if(!liff.isLoggedIn()){
      log("未ログイン → LINEログインへリダイレクト");
      liff.login({ redirectUri: location.href });
      return null;                 // ここで処理終了（戻ってきたら再実行される想定）
    }
    const idToken = liff.getIDToken();
    if(!idToken) throw new Error("IDトークンが取得できません（Scopeに openid が必要）");
    log("✅ IDトークン取得成功");
    return idToken;
  }

  async function resolveUser(idToken){
    log("ユーザーID解決中…");
    const r = await fetch("/api/resolve-user",{
      method:"POST",headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ idToken })
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error((data?.error||"resolve-user failed") + (data?.details?` - ${data.details}`:""));
    if(!data.userId) throw new Error("userId not returned");
    log("✅ ユーザーID: " + data.userId);
    return data.userId;
  }

  async function fetchStatus(userId){
    log("契約状況を取得中…");
    const r = await fetch(`/api/user/${encodeURIComponent(userId)}`, {cache:"no-store"});
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error("status failed " + r.status);

    // 反映（index.js準拠: premium/premiumSince/premiumUntil/cancelPending/cancelAt）
    $("#uid").textContent = userId;
    $("#premium").textContent = data.premium ? "プレミアム（有効）" : "無料プラン";
    $("#premiumSince").textContent = fmt(data.premiumSince);
    $("#premiumUntil").textContent = fmt(data.premiumUntil);
    $("#cancelPending").textContent = data.cancelPending ? "あり" : "なし";
    $("#cancelAt").textContent = fmt(data.cancelAt);

    const chip=$("#statusChip");
    chip.className = "chip " + (data.premium ? (data.cancelPending ? "warn":"ok") : "err");
    chip.textContent = data.premium ? (data.cancelPending ? "有効（解約予約あり）" : "有効") : "未契約/期限切れ";

    $("#statusCard").style.display="block";
    $("#hint").textContent = "本人確認が完了しました。契約状況を表示しています。";
  }

  async function openPortal(){
    if(!currentUserId) return;
    const url = `/billing-portal?userId=${encodeURIComponent(currentUserId)}`;
    log("Stripe請求ポータルへ移動: " + url);
    location.href = url;
  }

  async function startFlow(){
    if(running) return;
    running = true;
    $("#start").disabled = true;
    try{
      log("設定読み込み中…");
      const { liffIdMypage, liffIdPay, liffId } = await getConfig();
      const useId = liffIdMypage || liffIdPay || liffId;
      if(!useId) throw new Error("LIFF_ID_MYPAGE が未設定です。");

      log("使用するLIFF ID: " + useId);
      const idToken = await ensureLogin(useId);
      if(!idToken){ return; }                 // ログインへ遷移中

      currentUserId = await resolveUser(idToken);
      await fetchStatus(currentUserId);

      $("#reload").style.display = "inline-flex";
    }catch(e){
      console.error(e);
      log("エラー: " + (e?.message || e), true);
      alert(
        "マイページの読み込みに失敗しました。\n\n" + (e.message || e) +
        "\n\n（ヒント）LIFFのScopeに `openid` を含め、" +
        "LINEログインチャネルIDとサーバの `LINE_LOGIN_CHANNEL_ID` が一致しているか確認してください。"
      );
    }finally{
      $("#start").disabled = false;
      running = false;
    }
  }

  // イベント
  $("#start").addEventListener("click", startFlow);
  $("#reload").addEventListener("click", async ()=>{ if(currentUserId) await fetchStatus(currentUserId); });
  $("#reload2").addEventListener("click", async ()=>{ if(currentUserId) await fetchStatus(currentUserId); });
  $("#openPortal").addEventListener("click", openPortal);

  // 必要なら自動開始
  // window.addEventListener("DOMContentLoaded", startFlow);
</script>
</body>
</html>
