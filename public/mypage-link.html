<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>マイページ（契約状況）｜おしゃべりあいこちゃん</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#2f6df6; --border:#e8eaf0; --muted:#636a7a; --bg:#f5f7ff; --card:#fff;
      --ok:#2e7d32; --warn:#f57c00; --err:#d32f2f;
    }
    *{box-sizing:border-box}
    body{font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#222;margin:0;background:var(--bg)}
    header{padding:0;text-align:center;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    header img{
      width:min(90vw,300px); height:auto; display:block; margin:0 auto;
      border-bottom:2px solid #f0f2fa;
    }
    header h1{font-size:20px;font-weight:700;margin:10px 0 6px}
    main{max-width:760px;margin:0 auto;padding:20px 16px 40px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 18px;box-shadow:0 2px 8px rgba(0,0,0,.04);margin-bottom:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:12px;text-decoration:none;font-weight:700;cursor:pointer;border:1px solid var(--border);background:#fff;font-size:15px}
    .btn.brand{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .muted{color:var(--muted);font-size:13px}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .statuschip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:700}
    .status-ok{background:#e8f5e9;color:var(--ok)}
    .status-warn{background:#fff3e0;color:var(--warn)}
    .status-err{background:#ffebee;color:var(--err)}
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    th,td{text-align:left;padding:8px 4px;border-bottom:1px solid #f2f2f7;font-size:14px;vertical-align:top}
    th{color:#666;width:36%}
    td{color:#222}
    .break, .v code, td, .mono{word-break:break-all;overflow-wrap:anywhere}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    @media (max-width:420px){
      th,td{font-size:13px}
      .btn{font-size:14px}
    }
  </style>
<script>
  // LINE内ブラウザの場合は即座に外部ブラウザへリダイレクト
  (function() {
    const inLINE = /Line\//i.test(navigator.userAgent);
    if (inLINE) {
      // LIFFがロードされる前に外部ブラウザへ誘導
      const redirectUrl = 'https://www.oshaberiaiko.com/mypage-link.html';
      document.write(`
        <!DOCTYPE html>
        <html lang="ja">
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <title>外部ブラウザで開く</title>
          <style>
            body{font-family:sans-serif;text-align:center;padding:40px 20px;background:#f5f7ff}
            .card{background:#fff;border-radius:14px;padding:24px;max-width:400px;margin:0 auto;box-shadow:0 2px 8px rgba(0,0,0,.1)}
            h1{font-size:20px;color:#222;margin:0 0 16px}
            p{color:#636a7a;line-height:1.6;margin:0 0 20px}
            .btn{display:inline-block;padding:12px 24px;background:#2f6df6;color:#fff;text-decoration:none;border-radius:12px;font-weight:600}
          </style>
        </head>
        <body>
          <div class="card">
            <h1>📱 外部ブラウザで開く</h1>
            <p>マイページは外部ブラウザで開く必要があります。</p>
            <p>下のボタンをタップしてください。</p>
            <a href="${redirectUrl}" class="btn" onclick="openExternal(); return false;">Safariで開く</a>
            <p style="margin-top:16px;font-size:14px;color:#999">※ 自動で開かない場合はボタンをタップ</p>
          </div>
          <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"><\/script>
          <script>
            async function openExternal() {
              try {
                const liffId = '${process.env.LIFF_ID_MYPAGE || process.env.LIFF_ID || ''}';
                if (liffId && window.liff) {
                  await liff.init({ liffId });
                  await liff.ready;
                  if (liff.openWindow) {
                    liff.openWindow({ url: '${redirectUrl}', external: true });
                    return;
                  }
                }
              } catch(e) {
                console.error('LIFF error:', e);
              }
              // フォールバック
              window.location.href = '${redirectUrl}';
            }
            // 自動実行
            setTimeout(openExternal, 500);
          <\/script>
        </body>
        </html>
      `);
      return;
    }
  })();
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <img src="./aiko-mypage.png" alt="おしゃべりあいこちゃん マイページ">
    <h1>契約状況を確認</h1>
  </header>

  <main>
    <div class="card">
      <p class="muted" id="authHint">「LINEで続ける」を押して本人確認を行います。</p>
      <div class="row">
        <button id="start" class="btn brand">LINEで続ける</button>
        <button id="reload" class="btn" style="display:none">契約状況を更新</button>
      </div>
    </div>

    <div class="card" id="statusCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0;font-size:18px">契約ステータス</h2>
        <span id="statusChip" class="statuschip">読み込み中…</span>
      </div>
      <table>
        <tr>
          <th>ユーザーID</th>
          <td>
            <span id="uid" class="mono break">-</span>
            <button id="copyUid" class="btn" style="padding:6px 10px;margin-left:6px;">コピー</button>
          </td>
        </tr>
        <tr><th>ステータス</th><td id="premium">-</td></tr>
        <tr><th>開始日時</th><td id="premiumSince" class="break">-</td></tr>
        <tr><th>有効期限</th><td id="premiumUntil" class="break">-</td></tr>
        <tr><th>解約予約</th><td id="cancelPending">-</td></tr>
        <tr><th>解約予定日</th><td id="cancelAt" class="break">-</td></tr>
      </table>
      <div class="sep"></div>
      <div class="row">
        <button id="openPortal" class="btn brand" style="display:none">請求に関して（変更・解約）</button>
        <button id="upgradePremium" class="btn brand" style="display:none">プレミアムに登録する</button>
        <button id="reload2" class="btn">再取得</button>
      </div>
      <p class="muted" style="margin-top:8px" id="portalNote">※ 支払い方法の変更、解約/再開、請求履歴の確認ができます。</p>
    </div>
  </main>

<script>
(function() {
  'use strict';

  const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const isAndroid = /Android/i.test(navigator.userAgent);
  const inLINE = /Line\//i.test(navigator.userAgent);

  const $ = (s)=>document.querySelector(s);
  const fmt = (iso)=>{
    if(!iso) return "-";
    try{
      const d = new Date(iso);
      return new Intl.DateTimeFormat('ja-JP',{timeZone:'Asia/Tokyo',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d).replace(/\//g,'-');
    }catch{ return iso; }
  };

  let currentUserId = null;
  let running = false;
  let liffInitialized = false;

  // ループ防止：起動回数を記録（より寛容に）
  const SESSION_KEY = 'mypage_start_count';
  const MAX_STARTS = 5;  // 3回→5回に増やす
  
  function checkStartCount() {
    const count = parseInt(sessionStorage.getItem(SESSION_KEY) || '0');
    if (count >= MAX_STARTS) {
      alert('ログインに問題が発生しています。\n\n対処法：\n1. 「外部ブラウザで開く」ボタンを押す\n2. LINEアプリを再起動する\n3. スマホを再起動する');
      $("#start").disabled = true;
      $("#openExternal").style.display = "inline-flex";
      return false;
    }
    sessionStorage.setItem(SESSION_KEY, String(count + 1));
    return true;
  }

  // クリップボードコピー
  $("#copyUid").addEventListener("click", async ()=>{
    const text = $("#uid")?.textContent?.trim();
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      alert("ユーザーIDをコピーしました");
    } catch {
      const r = document.createRange();
      r.selectNodeContents($("#uid"));
      const s = window.getSelection();
      s.removeAllRanges(); s.addRange(r);
      alert("選択された状態でコピーしてください");
    }
  });

  // 外部ブラウザで開く（改善版）
  $("#openExternal").addEventListener("click", async ()=>{
    console.log('🔄 外部ブラウザで開く');
    
    // セッションをクリア
    sessionStorage.clear();
    
    // LINE内ブラウザの場合
    if (inLINE) {
      try {
        if (window.liff) {
          if (!liffInitialized) {
            const { liffId, liffIdMypage } = await getConfig();
            const useId = liffIdMypage || liffId;
            if (useId) {
              await liff.init({ liffId: useId });
              await liff.ready;
              liffInitialized = true;
            }
          }
          
          if (liff.openWindow) {
            const url = location.href.split('#')[0].split('?')[0];
            console.log('🌐 Opening in external browser:', url);
            liff.openWindow({ url: url, external: true });
            return;
          }
        }
      } catch(e) {
        console.error('LIFF openWindow failed:', e);
      }
    }
    
    // フォールバック：強制リロード
    console.log('🔄 Fallback: reload');
    location.reload();
  });

  async function getConfig(){
    const r = await fetch("/api/config", {cache:"no-store"});
    if(!r.ok) throw new Error("config load failed "+r.status);
    return r.json();
  }

  async function ensureLogin(liffId){
    if (!liffInitialized) {
      await liff.init({ liffId });
      await liff.ready;
      liffInitialized = true;
    }

    if (!liff.isLoggedIn()){
      console.log('🔄 未ログイン - リダイレクト');
      liff.login({ redirectUri: location.href.split('#')[0].split('?')[0] });
      return null;
    }

    // トークンの有効期限をチェック
    const decoded = liff.getDecodedIDToken();
    if (decoded && decoded.exp) {
      const nowSec = Math.floor(Date.now() / 1000);
      const expSec = decoded.exp;
      const timeDiff = expSec - nowSec;
      
      console.log('🕐 Token expiry check:', {
        exp: new Date(expSec * 1000).toISOString(),
        now: new Date(nowSec * 1000).toISOString(),
        diff: timeDiff + ' seconds'
      });
      
      // 有効期限切れ、または10秒以内に切れる場合は再ログイン
      if (timeDiff < 10) {
        console.log('⚠️ Token expired or expiring soon - re-login');
        // ログアウトしてから再ログイン
        try { liff.logout(); } catch(_){}
        liff.login({ 
          redirectUri: location.href.split('#')[0].split('?')[0],
          prompt: 'consent' 
        });
        return null;
      }
    }

    const idToken = liff.getIDToken();
    if (!idToken) {
      throw new Error('IDトークン取得失敗。LIFFのScopeに openid が含まれているか確認してください。');
    }

    console.log('✅ IDトークン取得成功');
    return idToken;
  }

  async function resolveUser(idToken){
    const r = await fetch("/api/resolve-user", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ idToken }),
      cache: "no-store"
    });
    
    const data = await r.json().catch(()=> ({}));

    if (r.status === 401) {
      const details = (data?.details || '').toLowerCase();
      
      if (details.includes('audience') || details.includes('aud') || details.includes('channel id')) {
        throw new Error('⚠️ 設定エラー：LIFFのチャネルIDとサーバーのLINE_LOGIN_CHANNEL_IDが一致していません');
      }
      
      throw new Error(data?.details || '認証エラーが発生しました');
    }

    if (!r.ok) {
      throw new Error((data?.error || "resolve-user failed") + (data?.details ? " - " + data.details : ""));
    }
    if (!data.userId) throw new Error("userId not returned");
    
    return data.userId;
  }

  async function fetchStatus(userId){
    const r = await fetch(`/api/user/${encodeURIComponent(userId)}`, { cache:"no-store" });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error("status failed " + r.status);

    $("#uid").textContent = userId;
    $("#premium").textContent = data.premium ? "プレミアム（有効）" : "無料プラン";
    $("#premiumSince").textContent = fmt(data.premiumSince);
    $("#premiumUntil").textContent = fmt(data.premiumUntil);
    $("#cancelPending").textContent = data.cancelPending ? "あり" : "なし";
    $("#cancelAt").textContent = fmt(data.cancelAt);

    const chip = $("#statusChip");
    chip.className = "statuschip " + (data.premium ? (data.cancelPending ? "status-warn":"status-ok") : "status-err");
    chip.textContent = data.premium ? (data.cancelPending ? "有効（解約予約あり）" : "有効") : "未契約 / 期限切れ";

    // プレミアム会員かどうかでボタンを切り替え
    if (data.premium) {
      // プレミアム会員：請求ポータルボタンを表示
      $("#openPortal").style.display = "inline-flex";
      $("#upgradePremium").style.display = "none";
    } else {
      // 一般会員：プレミアム登録ボタンを表示
      $("#openPortal").style.display = "none";
      $("#upgradePremium").style.display = "inline-flex";
    }

    $("#statusCard").style.display = "block";
    $("#authHint").textContent = "本人確認が完了しました。";
    $("#reload").style.display = "inline-flex";
    $("#start").style.display = "none";
    
    // 成功したらカウンターをリセット
    sessionStorage.removeItem(SESSION_KEY);
  }

  async function openPortal(){
    if(!currentUserId) {
      alert('ユーザー情報が取得できていません。ページを再読み込みしてください。');
      return;
    }
    
    console.log('🔄 Opening billing portal for user:', currentUserId);
    
    try {
      // ポータルURLを取得してから遷移
      const portalUrl = `/billing-portal?userId=${encodeURIComponent(currentUserId)}`;
      console.log('Portal URL:', portalUrl);
      
      // 直接遷移
      window.location.href = portalUrl;
    } catch (e) {
      console.error('Portal open error:', e);
      alert('請求ページを開けませんでした。もう一度お試しください。');
    }
  }

  async function upgradeToPremium(){
    if(!currentUserId) {
      alert('ユーザー情報が取得できていません。ページを再読み込みしてください。');
      return;
    }
    
    console.log('🔄 Redirecting to premium registration for user:', currentUserId);
    
    // プレミアム登録ページへ遷移
    window.location.href = 'https://www.oshaberiaiko.com/pay.html';
  }

  async function startFlow(){
    if(running) return;
    running = true;
    
    // ループ防止チェック
    if (!checkStartCount()) {
      running = false;
      return;
    }
    
    $("#statusCard").style.display = "none";
    $("#reload").style.display = "none";
    $("#start").disabled = true;
    $("#start").textContent = "読み込み中...";

    try{
      const { liffIdMypage, liffId } = await getConfig();
      const useId = liffIdMypage || liffId;
      
      if(!useId) {
        throw new Error("LIFF_ID_MYPAGE が未設定です。管理者に連絡してください。");
      }

      const idToken = await ensureLogin(useId);
      if(!idToken) {
        // リダイレクト中
        console.log('🔄 Redirecting to LINE login...');
        return;
      }

      const userId = await resolveUser(idToken);
      if(!userId) {
        // リダイレクト中
        console.log('🔄 Redirecting after user resolution...');
        return;
      }
      
      currentUserId = userId;
      console.log('✅ User ID resolved:', userId);

      // Android対策：タイムアウト付き
      const timeout = new Promise((_,rej)=> 
        setTimeout(()=>rej(new Error('render_timeout')), 10000)
      );
      
      await Promise.race([ fetchStatus(userId), timeout ]);

      $("#start").style.display = "none";
      $("#reload").style.display = "inline-flex";
      
    } catch(e) {
      console.error('❌ startFlow error:', e);
      
      if (e.message === 'render_timeout' && isAndroid && inLINE) {
        console.log('⚠️ Android描画タイムアウト');
        if (window.liff && liff.openWindow) {
          liff.openWindow({ url: location.href.split('#')[0].split('?')[0], external: true });
          return;
        }
      }
      
      const errorMsg = e.message || String(e);
      console.error('Error details:', errorMsg);
      
      // ユーザーフレンドリーなエラーメッセージ
      let userMsg = "マイページの読み込みに失敗しました。\n\n";
      
      if (errorMsg.includes('exp') || errorMsg.includes('期限')) {
        userMsg += "認証の有効期限が切れています。\nもう一度「LINEで続ける」ボタンを押してください。";
      } else if (errorMsg.includes('Channel ID') || errorMsg.includes('aud')) {
        userMsg += "設定エラーが発生しています。\n管理者に連絡してください。";
      } else {
        userMsg += errorMsg + "\n\n「外部ブラウザで開く」ボタンをお試しください。";
      }
      
      alert(userMsg);
      
      // エラー後もボタンを有効化
      $("#start").textContent = "LINEで続ける";
      $("#start").disabled = false;
      
    } finally {
      if ($("#start").textContent === "読み込み中...") {
        $("#start").textContent = "LINEで続ける";
      }
      $("#start").disabled = false;
      running = false;
    }
  }

  $("#start").addEventListener("click", startFlow);
  $("#reload").addEventListener("click", async ()=>{
    if(!currentUserId) return startFlow();
    await fetchStatus(currentUserId);
  });
  $("#reload2")?.addEventListener("click", async ()=>{
    if(currentUserId) await fetchStatus(currentUserId);
  });
  $("#openPortal").addEventListener("click", openPortal);
  $("#upgradePremium").addEventListener("click", upgradeToPremium);

  // 自動開始（1回のみ）
  window.addEventListener("DOMContentLoaded", ()=>{
    // URLパラメータでループ検出
    const params = new URLSearchParams(location.search);
    if (params.has('retry')) {
      alert('ログインに問題が発生しています。外部ブラウザで開くボタンを押してください。');
      $("#start").disabled = true;
      return;
    }
    
    startFlow();
  });
})();
</script>
</body>
</html>
